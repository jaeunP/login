# 프로젝트 내용 정리

---

## Login 방식

### 로그인의 핵심 비즈니스 로직은 회원 조회로 `id`와 `password`가 같으면 회원을 반환, 아니면 `null`을 반환하도록 설계

### V1
- 로그인 서비스를 호출하여 로그인에 성공하면 HTTP 응답에 쿠키를 담아서 브라우저에 전달
- @CookieValue를 사용하여 편리하게 쿠키 조회
- 로그아웃은 쿠키의 만료 날짜를 0으로 지정

**V1의 문제점**
- 쿠키값 임의 변경 가능
- 쿠키에 보관된 정보는 보안이 취약
- 쿠키가 해킹당하면 악의적으로 평생 이용할 수도 있다.

**해결법**
- 쿠키에 중요한 값을 노출하지않고, 랜덤 토큰을 생성하여 서버에서 토큰 관리
- 세션 동작 방식을 사용

> **쿠키의 종류**<br>
영속 쿠키: 만료 날짜를 입력하면 해당 날짜까지 유지<br>
세션 쿠키: 만료 날짜를 생략하면 브라우저 종료시 까지만 유지

### V2
- 로그인 성공시 세션을 등록하고 저장하며 쿠키도 함께 발행한다.
- 세션을 직접 만들어서 관리
- 세션 관리자에서 저장된 회원 정보를 조회하여 로그인 처리
- 로그인 할때마다 다른 `Value`가 저장된다.
- 로그아웃시 해당 세션의 정보를 제거

### V3
- HttpSession을 사용하여 세션 생성, 관리
- 로그인 시 `JSESSIONID` 쿠키가 생성되며 변경된다

> `JSESSIONID`란?
- 톰캣 컨테이너에서 세션을 유지하기 위해 발급하는 키
- HTTP 프로토콜은 stateless하다. 요청시마다 새로운 연결이 생성되고 응답후 연결은 끊기게 되므로 상태를 유지할 수 없다.
- 따라서, 상태를 저장하기 위해서 톰캣은 JSESSIONID 쿠키를 클라이언트에게 발급해주고 이 값을 통해 세션을 유지할 수 있도록 한다.

---

## 서블릿 필터
- ### 필터의 흐름
  -  필터는 특정 URL 패턴에 적용할 수 있다
  - 모든 고객의 요청 로그를 남길 때 필터를 사용
  -  HTTP 요청 → WAS → 필터 → 서블릿 → 컨트롤러
- ### 필터 제한
  - 필터가 적절하지 않은 요청이라고 판단하면 요청 중지 가능, 로그인 여부를 체크하기에 적합하다
  - (1) 로그인 사용자
    -  HTTP 요청 → WAS → 필터 → 서블릿 → 컨트롤러
  - (2) 비 로그인 사용자
    - HTTP 요청 → WAS → 필터(적절하지 않은 요청이라 판단, 서블릿 호출X)
- ### 필터 체인
  - 중간에 필터를 자유롭게 추가할수 있다
  - HTTP 요청 → WAS → 필터1 → 필터2 → 필터3 → 서블릿 → 컨트롤러
  
- ### 필터 인터페이스
  - 필터 인터페이스를 구현하고 등록하면 서블릿 컨테이너가 필터를 싱글톤 객체로 생성하고 관리
  - `FilterRegistrationBean`을 사용해서 등록

### LogFilter
- 모든 요청을 로그로 남기는 필터
- HTTP 요청이 오면 `doFilter`가 호출

### LoginCheckFilter
- 로그인 체크 필터
- 화이트 리스트를 제외한 모든 경로에 로직 적용

### login V4
- 로그인에 성공하면 처음 요청한 URL로 이동하는 기능
- 로그인 체크 필터에서, 미인증 사용자는 요청 경로를 포함해서 /login 에 redirectURL 요청 파라미터를 추가해서 요청
- 이 값을 사용해서 로그인 성공시 해당 경로로 고객을 redirect

---

## 스프링 인터셉터
#### 스프링 MVC 구조에 특화된 필터 기능을 제공
#### 스프링 MVC를 사용하고, 특별히 필터를 꼭 사용해야 하는 상황이 아니라면 인터셉터를 사용하는 것이 더 편리


- ### 스프링 인터셉터 흐름
  - HTTP 요청 → WAS → 필터 → 서블릿 → 스프링 인터셉터 → 컨트롤러
  - 서블릿과 컨트롤러 사이에서 컨트롤러 호출 직전에 호출 된다
  - 스프링 인터셉터는 스프링 MVC가 제공하는 기능이기 때문에 결국 디스패처 서블릿 이후에 등장하게 된다.
  - 스프링 인터셉터에도 URL 패턴을 적용할 수 있는데, 서블릿 URL 패턴과는 다르고, 매우 정밀하게 설정할 수 있다.

- ### 스프링 인터셉터 제한
  - 필터가 적절하지 않은 요청이라고 판단하면 요청 중지 가능
  - 로그인 사용자
    - 요청 → WAS → 필터 → 서블릿 → 스프링 인터셉터 → 컨트롤러
  - 비 로그인 사용자
    - HTTP 요청 → WAS → 필터 → 서블릿 → 스프링 인터셉터(적절하지 않은 요청이라 판단, 컨트롤러 호출 X)

- ### 스프링 인터셉터 체인
  - HTTP 요청 → WAS → 필터 → 서블릿 → 인터셉터1 → 인터셉터2 → 컨트롤러
  - 중간에 인터셉터를 자유롭게 추가할 수 있다.

- ### 스프링 인터셉터 인터페이스
- 스프링의 인터셉터를 사용하려면 HandlerInterceptor 인터페이스를 구현하면 된다.

### preHandle
- 컨트롤러 호출 전에 호출
- 응답값이 `true`면 다음으로 진행, `false`면 진행 안함
- `false`인 경우 핸들러 어뎁터도 호출되지 않음

### PostHandle
- 컨트롤러 호출 후에 호출
- 컨트롤러에서 예외가 발생하면 호출되지 않는다

### afterCompletion
- 뷰가 렌더링 된 이후에 호출
- 예외와 관계 없이 항상 호출
  - 따라서 공통 처리는 여기서 진행한다
- 예외를 파라미터로 받아서 어떤 예외가 발생했는지 로그로 출력 가능
















